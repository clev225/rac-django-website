{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if blog %}Edit Blog{% else %}Create Blog{% endif %}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'styles/blog-list.css' %}">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Poppins', sans-serif;
        }
        .form-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 30px;
        }
        .form-title {
            color: #276695;
            font-weight: 600;
            margin-bottom: 25px;
        }
        .form-label {
            font-weight: 500;
            color: #555;
        }
        .btn-primary {
            background-color: #276695;
            border-color: #276695;
            white-space: nowrap;
        }
        .btn-primary:hover {
            background-color: rgb(25, 73, 110);
            border-color: rgb(25, 73, 110);
        }
        .image-preview {
            max-width: 300px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        .note-editor {
            border-radius: 0.25rem;
        }

        /* Responsive button styles */
        @media (max-width: 576px) {
            .btn {
                padding: 0.375rem 0.5rem;
                font-size: 0.875rem;
            }
            .form-action-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                width: 100%;
            }
            .form-action-buttons .btn {
                flex: 1;
                min-width: 120px;
                margin: 0 !important;
            }
        }
        
        @media (max-width: 375px) {
            .btn {
                padding: 0.25rem 0.4rem;
                font-size: 0.75rem;
            }
            .btn i {
                margin-right: 0.2rem !important;
            }
        }
    </style>
</head>
<body>

    {% include 'blog-navbar.html' %}

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="form-container">
                    <h2 class="form-title">{% if blog %}Edit Blog{% else %}Create New Blog{% endif %}</h2>
                    
                    <form method="POST" enctype="multipart/form-data" action="{% if blog %}{% url 'update_blog' blog.id %}{% else %}{% url 'create_blog' %}{% endif %}">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="blogTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="blogTitle" name="title" placeholder="Enter blog title here..." value="{% if blog %}{{ blog.title }}{% endif %}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="author" class="form-label">Author</label>
                            <input type="text" class="form-control" id="author" name="author" value="{% if blog %}{{ blog.author }}{% endif %}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="datePublished" class="form-label">Date Published</label>
                            <input type="date" class="form-control" id="datePublished" name="date_published" value="{% if blog %}{{ blog.date_published|date:'Y-m-d' }}{% endif %}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="blogDescription" class="form-label">Short Description</label>
                            <textarea class="form-control" id="blogDescription" name="description" rows="3" placeholder="Enter blog description here..." required>{% if blog %}{{ blog.description }}{% endif %}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="blogContent" class="form-label">Content <span class="text-muted">(Maximum 10,000 characters)</span></label>
                            <textarea class="form-control" id="blogContent" name="content" rows="10" 
                                placeholder="Enter your full blog content here..." 
                                required
                                maxlength="10000"
                                oninput="this.nextElementSibling.value = (10000 - this.value.length) + ' characters remaining'">{% if blog %}{{ blog.content }}{% endif %}</textarea>
                            <output class="form-text text-muted d-block mt-1">{% if blog %}{{ 10000|add:"-"|add:blog.content|length }} characters remaining{% else %}10000 characters remaining{% endif %}</output>
                        </div>
                        
                        <div class="mb-3">
                            <label for="blogIllustration" class="form-label">Image</label>
                            <input type="file" class="form-control" id="blogIllustration" name="image" accept="image/png, image/jpeg, image/jpg" {% if not blog %}required{% endif %}>
                            
                            {% if blog and blog.image %}
                                <div class="mt-2">
                                    <img src="{{ blog.image.url }}" class="image-preview" alt="{{ blog.title }}">
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="keepImage" name="keep_image" value="yes" checked>
                                        <label class="form-check-label" for="keepImage">
                                            Keep current image if no new image is uploaded
                                        </label>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4 form-action-buttons">
                            <a href="{% url 'blog_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i> <span class="d-none d-sm-inline">Back to Blogs</span><span class="d-inline d-sm-none">Back</span>
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-secondary me-2" id="previewButton">
                                    <i class="fas fa-eye me-1"></i> <span class="d-none d-sm-inline">Preview</span><span class="d-inline d-sm-none">Preview</span>
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i> <span class="d-none d-sm-inline">{% if blog %}Update{% else %}Create{% endif %} Blog</span><span class="d-inline d-sm-none">{% if blog %}Update{% else %}Create{% endif %}</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">Blog Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="preview-container">
                        <h2 id="previewTitle" class="mb-3"></h2>
                        <div class="d-flex justify-content-between mb-3">
                            <p class="text-muted">By: <span id="previewAuthor"></span></p>
                            <p class="text-muted">Published: <span id="previewDate"></span></p>
                        </div>
                        <div class="text-center mb-4">
                            <img id="previewImage" src="" alt="Blog illustration" class="img-fluid rounded mx-auto d-block" style="max-height: 300px; display: none;">
                            <div id="noImagePlaceholder" class="bg-light rounded p-5 text-center text-muted" style="display: none;">
                                <i class="fas fa-image fa-3x mb-3"></i>
                                <p>No image selected</p>
                            </div>
                        </div>
                        <div class="mb-4">
                            <h5>Description</h5>
                            <p id="previewDescription" class="border-start border-primary ps-3"></p>
                        </div>
                        <div>
                            <h5>Content</h5>
                            <div id="previewContent" class="border-start border-primary ps-3"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Calculate remaining characters on page load
            const contentTextarea = document.getElementById('blogContent');
            if (contentTextarea) {
                const output = contentTextarea.nextElementSibling;
                output.value = (10000 - contentTextarea.value.length) + ' characters remaining';
            }
        });

        // Preview button functionality
        const previewButton = document.getElementById('previewButton');
        const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
        
        previewButton.addEventListener('click', function() {
            // Get current form values
            const title = document.getElementById('blogTitle').value || 'Untitled Blog';
            const author = document.getElementById('author').value || 'Anonymous';
            const datePublished = document.getElementById('datePublished').value || 'Not specified';
            const description = document.getElementById('blogDescription').value || 'No description provided.';
            const content = document.getElementById('blogContent').value || 'No content provided.';
            
            // Format date if available
            let formattedDate = datePublished;
            if (datePublished && datePublished !== 'Not specified') {
                const date = new Date(datePublished);
                formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric'
                });
            }
            
            // Update modal with current values
            document.getElementById('previewTitle').textContent = title;
            document.getElementById('previewAuthor').textContent = author;
            document.getElementById('previewDate').textContent = formattedDate;
            document.getElementById('previewDescription').textContent = description;
            
            // Handle content with paragraphs
            const contentDiv = document.getElementById('previewContent');
            contentDiv.innerHTML = '';
            const paragraphs = content.split('\n');
            paragraphs.forEach(paragraph => {
                if (paragraph.trim()) {
                    const p = document.createElement('p');
                    p.textContent = paragraph;
                    contentDiv.appendChild(p);
                }
            });
            
            // Handle image preview
            const imageInput = document.getElementById('blogIllustration');
            const previewImage = document.getElementById('previewImage');
            const noImagePlaceholder = document.getElementById('noImagePlaceholder');
            
            // Check if there's a new image selected
            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    noImagePlaceholder.style.display = 'none';
                }
                reader.readAsDataURL(imageInput.files[0]);
            } 
            // Check if there's an existing image (for edit mode)
            else if (document.querySelector('.image-preview')) {
                const currentImageUrl = document.querySelector('.image-preview').getAttribute('src');
                previewImage.src = currentImageUrl;
                previewImage.style.display = 'block';
                noImagePlaceholder.style.display = 'none';
            }
            // No image case
            else {
                previewImage.style.display = 'none';
                noImagePlaceholder.style.display = 'block';
            }
            
            // Show the modal
            previewModal.show();
        });
    </script>
</body>
</html>